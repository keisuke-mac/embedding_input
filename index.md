# Embedding法(未完)

以下で使うプログラムは圧縮ファイルとしてsmith上の`/home/kota/Embedding/compressed_file`に置いてあります。使用される場合は必要なものをこのディレクトリからコピーするようにしてください。

## 実行プログラム

`EmApw.tgz`を任意のディレクトリにコピーします。次にファイルを解凍をします。

```
tar -xvzf EmApw.tgz
```
解凍できたら

```
cd EmApw
```

でディレクトリに入ります。smith上であればコンパイラloadしてください(最新のものは対応できていなかったりすることがあるので避けましょう)。
```
module load intel/2020.2.254
module load intelmpi/2020.2.254
```
ohtakaではコンパイラを自動的にloadするので必要はありません。準備が整えば
```
make
```

カレントディレクトリ内に`emapw.out`が作成されていたら成功です。


## Cu(100)のSCF計算


```
tar -xvzf Cu_001_7x7_scf.tgz
```

でファイルを解凍し、ディレクトリ内に入ります。

- input.dat
- param.dat
- d3ps-pot.dat（FCC Cu 原子球外側の領域のポテンシャル）
- g_emb.dat（表面領域とバルクとの境界面の構造データ）
- orb.dat（DOSを射影する軌道のデータ：s, px, py, pz・・・・）

があることをご確認ください。
<br>
次にサブfolderの./e_pot_scf中に`00.vemb.dat`を用意します(元々あるかもしれませんが中身がないダミーです)。このファイルは`Cu_001_7x7_scf_embpot.tgz`を解凍すれば展開されるので任意のディレクトリで解凍し、コピーするかシンボリックリンクするかしてください。

<br>
### ohtakaでの計算
続いて計算です。job scriptは

```
#!/bin/sh
#SBATCH -J  Cu_surface
#SBATCH -p  cmdinteractive
#SBATCH -N  1
#SBATCH -n  64

module load intel_compiler/2020.2.254
module load intel_mpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
srun  ~/EmApw/emapw.out
rm -f hostfile.$JOB_ID
```

です。ただし`emapw.out`のパスはご自身のものを指定してください。またコンパイラもご自身の環境により適宜変更してください。

### smithでの計算

```
#$ -S /bin/bash
#$ -cwd
#$ -q xh2.q
#$ -pe x24 24
#$ -N Cu001_7x7 
#$ -j y

module load intel/2020.2.254
module load intelmpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

#disable OPENMP parallelism
export OMP_NUM_THREADS=1
export I_MPI_ADJUST_ALLGATHERV=2
export I_MPI_PIN=1
cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
mpirun -n 64  /home/kota/Embedding/EmApw/emapw.out
rm -f hostfile.$JOB_ID
```
ohtakaと同様にシンボリックリンクなどはご自身の環境に応じて変更を加えてください。


### 計算状況の確認
計算の収束状況は
```
grep "jte, rms" 00.output
```
により確認できます。rmsは入力電子密度と出力電子密度の差をユニットセルで平均したものです（Hartree原子単位）。
<br>
計算が収束すると
```
grep evcm 00.output
```
により真空準位を確認することができます。今回のCuのフェルミエネルギー$\mathrm{E}_F$は$0.325\, \mathrm{Hartree}$なので仕事関数は$(\mathrm{evcm}-0.325)\times 27.211386\,eV$と計算でき、結果から仕事関数は4.59eVとなるはずです。


## input


```
   0.d0      33.813626d0
  90.d0      33.813626d0
  1      0.d0   0.d0  0.d0  1.d0
 14.1d0    14.1d0     0.5d0   0.5d0
 3.5d0
 16.d0
 49                     
      0.00000000      0.00000000      2.40000000      2.40000000
      0.00000000      4.83051800      2.40000000      2.40000000
      0.00000000      9.66103600      2.40000000      2.40000000
      0.00000000     14.49155400      2.40000000      2.40000000
      0.00000000     19.32207200      2.40000000      2.40000000
      0.00000000     24.15259000      2.40000000      2.40000000
      0.00000000     28.98310800      2.40000000      2.40000000
      4.83051800      0.00000000      2.40000000      2.40000000
      4.83051800      4.83051800      2.40000000      2.40000000
      4.83051800      9.66103600      2.40000000      2.40000000
      4.83051800     14.49155400      2.40000000      2.40000000
      4.83051800     19.32207200      2.40000000      2.40000000
      4.83051800     24.15259000      2.40000000      2.40000000
      4.83051800     28.98310800      2.40000000      2.40000000
      9.66103600      0.00000000      2.40000000      2.40000000
      9.66103600      4.83051800      2.40000000      2.40000000
      9.66103600      9.66103600      2.40000000      2.40000000
      9.66103600     14.49155400      2.40000000      2.40000000
      9.66103600     19.32207200      2.40000000      2.40000000
      9.66103600     24.15259000      2.40000000      2.40000000
      9.66103600     28.98310800      2.40000000      2.40000000
     14.49155400      0.00000000      2.40000000      2.40000000
     14.49155400      4.83051800      2.40000000      2.40000000
     14.49155400      9.66103600      2.40000000      2.40000000
     14.49155400     14.49155400      2.40000000      2.40000000
     14.49155400     19.32207200      2.40000000      2.40000000
     14.49155400     24.15259000      2.40000000      2.40000000
     14.49155400     28.98310800      2.40000000      2.40000000
     19.32207200      0.00000000      2.40000000      2.40000000
     19.32207200      4.83051800      2.40000000      2.40000000
     19.32207200      9.66103600      2.40000000      2.40000000
     19.32207200     14.49155400      2.40000000      2.40000000
     19.32207200     19.32207200      2.40000000      2.40000000
     19.32207200     24.15259000      2.40000000      2.40000000
     19.32207200     28.98310800      2.40000000      2.40000000
     24.15259000      0.00000000      2.40000000      2.40000000
     24.15259000      4.83051800      2.40000000      2.40000000
     24.15259000      9.66103600      2.40000000      2.40000000
     24.15259000     14.49155400      2.40000000      2.40000000
     24.15259000     19.32207200      2.40000000      2.40000000
     24.15259000     24.15259000      2.40000000      2.40000000
     24.15259000     28.98310800      2.40000000      2.40000000
     28.98310800      0.00000000      2.40000000      2.40000000
     28.98310800      4.83051800      2.40000000      2.40000000
     28.98310800      9.66103600      2.40000000      2.40000000
     28.98310800     14.49155400      2.40000000      2.40000000
     28.98310800     19.32207200      2.40000000      2.40000000
     28.98310800     24.15259000      2.40000000      2.40000000
     28.98310800     28.98310800      2.40000000      2.40000000
 29.d0   7
 100   200   210   300   310   325    405
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
 60.d0    32.d0
 2
 -0.5d0    0.32500628d0   15
 31
 6          1        40
 0.9975     1.d-5
```
原子座標以下のパラメーターについて

```
29.d0   7　
```
原子番号、軌道数
```
100   200   210   300   310   325    405
```
Cu原子の軌道
```
2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
```
軌道占有電子数
```
60.d0    32.d0
```
LAPWの原子球のradial meshの刻みの情報となりますが、これらは格子面に依存しません。


<br>
最後から二行目について
```
6          1        40
```

の欄でiterationを指定することができます。初めの６は電子のmixingを指定しています。最新6iterationのinputとoutputを混ぜて次のiterationの電子密度を計算します。次の１は１stを意味し最初から始めることを表しており、計算結果の収束が不十分なときに変更を加えて再度計算する形になります。最後の行はどれだけiterationを回すかを指定でき、この場合40iterationです。

embedding potentialのパートは編集中です。